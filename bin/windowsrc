# PowerShell script to set up Windows with WSL2, Ubuntu, PowerShell, and Chocolatey

$RED = "Red"
$GREEN = "Green"
$YELLOW = "Yellow"
$MAGENTA = "Magenta"

# Helper function to write colored messages
function Write-Color {
    param (
        [string]$Message,
        [string]$Color
    )
    Write-Host $Message -ForegroundColor $Color
}

Write-Color "Starting installation..." $YELLOW

# Check for administrative privileges
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Color "You need to run this script as an Administrator." $RED
    exit
}

# Install WSL and Ubuntu
Write-Color "Installing WSL and Ubuntu..." $YELLOW
wsl --install -d Ubuntu

# Install PowerShell
Write-Color "Installing PowerShell..." $YELLOW
if (-not (Get-Command "pwsh" -ErrorAction SilentlyContinue)) {
    # Download and install PowerShell
    $powershellUrl = "https://github.com/PowerShell/PowerShell/releases/download/v7.3.0/PowerShell-7.3.0-win-x64.msi"
    $installerPath = "$env:TEMP\PowerShell-7.3.0-win-x64.msi"
    Invoke-WebRequest -Uri $powershellUrl -OutFile $installerPath
    Start-Process msiexec.exe -ArgumentList "/i", $installerPath, "/quiet", "/norestart" -NoNewWindow -Wait
    Remove-Item -Path $installerPath
} else {
    Write-Color "PowerShell is already installed" $GREEN
}

# Install Chocolatey
Write-Color "Installing Chocolatey..." $YELLOW
if (-not (Get-Command "choco" -ErrorAction SilentlyContinue)) {
    Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
} else {
    Write-Color "Chocolatey is already installed" $GREEN
}

# Verify installations
Write-Color "Verifying installations..." $YELLOW

# Verify WSL and Ubuntu
if (wsl -l -v) {
    Write-Color "WSL and Ubuntu are installed" $GREEN
} else {
    Write-Color "WSL and Ubuntu installation failed" $RED
}

# Verify PowerShell
if (Get-Command "pwsh" -ErrorAction SilentlyContinue) {
    Write-Color "PowerShell is installed" $GREEN
} else {
    Write-Color "PowerShell installation failed" $RED
}

# Verify Chocolatey
if (Get-Command "choco" -ErrorAction SilentlyContinue) {
    Write-Color "Chocolatey is installed" $GREEN
} else {
    Write-Color "Chocolatey installation failed" $RED
}

Write-Color "Installation completed." $MAGENTA
