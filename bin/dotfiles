#!/bin/bash

set -e # exit in a error

SSH_DIR="$HOME/.ssh"
DOTFILES_DIR="$HOME/.dotfiles"
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# ANSIBLE
echo -e "${YELLOW}Verify if ANSIBLE is installed${NC}"
if ! [ "$(command -v ansible)" ]; then
  echo -e "${RED}not installed.. Installing...\n${NC}"
  sudo pacman -S ansible --noconfirm
else
  echo -e "${GREEN}is already installed${NC}"
fi

# GIT
echo -e "\n${YELLOW}Verify if GIT is installed"
if ! [[ "$(command -v git)" ]]; then
  echo -e "${RED}not installed.. Installing...\n${NC}"
  sudo pacman -S git --noconfirm
else
  echo -e "${GREEN}is already installed${NC}"
fi

# Bash
echo -e "\n${YELLOW}Verify if OH-MY-BASH is installed"
if ! [[ -e "$HOME/.oh-my-bash" ]]; then
  echo -e "${RED}not installed.. Installing...\n${NC}"
  bash -c "$(curl -fsSL https://raw.githubusercontent.com/ohmybash/oh-my-bash/master/tools/install.sh)"
else
  echo -e "${GREEN}is already installed${NC}"
  echo
fi

# Nvm
echo -e "\n${YELLOW}Verify if NVM is installed"
if ! [[ -x "$HOME/.nvm" ]]; then
  echo -e "${RED}not installed.. Installing...\n${NC}"
  curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
else
  echo -e "${GREEN}is already installed\n${NC}"
fi

# SSH
echo -e "\n${YELLOW}Verify if the ssh key was genereted"
if ! [[ -e "$SSH_DIR/id_rsa" ]]; then
  echo -e "${RED}not generated.. generating...\n${NC}"

  mkdir -p "$SSH_DIR"

  chmod 700 "$SSH_DIR"

  ssh-keygen -b 4096 -t rsa -f "$SSH_DIR/id_rsa" -N "" -C "$USER@HOSTNAME"

  cat "$SSH_DIR/id_rsa.pub" >> "$SSH_DIR/authorized_keys"

  chmod 600 "$SSH_DIR/authorized_keys"
else
  echo -e "${GREEN}was already generated\n${NC}"
fi

# Run the PLAYBOOK
echo -e "${MAJENTA}INIT PLAYBOOK\n${NC}"
ansible-playbook --diff "$DOTFILES_DIR/main.yml"
